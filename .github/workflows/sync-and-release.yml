# ============================================================
# OpenClaw æ±‰åŒ–å‘è¡Œç‰ˆ - ç¨³å®šç‰ˆå‘å¸ƒå·¥ä½œæµ
# æ­¦æ±‰æ™´è¾°å¤©ä¸‹ç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸ | https://qingchencloud.com/
# ============================================================
# 
# è§¦å‘æ–¹å¼ï¼š
#   1. æŽ¨é€ tagï¼ˆæ ¼å¼ï¼šv*ï¼Œå¦‚ v2026.1.30-zh.1ï¼‰
#   2. æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºŽç´§æ€¥å‘å¸ƒï¼‰
#
# ç‰ˆæœ¬è¯´æ˜Žï¼š
#   - ç¨³å®šç‰ˆ (@latest)ï¼šæœ¬å·¥ä½œæµå‘å¸ƒï¼Œæ‰‹åŠ¨æ‰“ tag è§¦å‘
#   - æœ€æ–°ç‰ˆ (@nightly)ï¼šnightly.yml å‘å¸ƒï¼Œæ¯å°æ—¶è‡ªåŠ¨æž„å»º
# ============================================================

name: ç¨³å®šç‰ˆå‘å¸ƒ

on:
  push:
    tags:
      - 'v*'  # ç›‘å¬æ‰€æœ‰ v å¼€å¤´çš„ tag
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å·ï¼ˆå¦‚ 2026.1.30-zh.1ï¼Œä¸å« v å‰ç¼€ï¼‰'
        required: true
        type: string

env:
  UPSTREAM_REPO: openclaw/openclaw
  NODE_VERSION: '22'

permissions:
  contents: write
  packages: write

jobs:
  # ==================== ç¨³å®šç‰ˆæž„å»ºä¸Žå‘å¸ƒ ====================
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ç¡®å®šç‰ˆæœ¬å·
        id: version
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            # ä»Ž tag æå–ç‰ˆæœ¬å·ï¼ˆåŽ»æŽ‰ v å‰ç¼€ï¼‰
            TAG_NAME="${{ github.ref_name }}"
            VERSION="${TAG_NAME#v}"
          else
            # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥çš„ç‰ˆæœ¬å·
            VERSION="${{ inputs.version }}"
          fi
          
          echo "release_version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ å‘å¸ƒç‰ˆæœ¬: $VERSION"

      - name: èŽ·å–ä¸Šæ¸¸ç‰ˆæœ¬
        id: upstream
        run: |
          UPSTREAM_VERSION=$(curl -s https://registry.npmjs.org/openclaw/latest | jq -r '.version')
          echo "version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ ä¸Šæ¸¸ç‰ˆæœ¬: $UPSTREAM_VERSION"

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: å…‹éš†ä¸Šæ¸¸ä»£ç 
        run: |
          git clone --depth 1 https://github.com/${{ env.UPSTREAM_REPO }}.git openclaw
          echo "âœ… ä¸Šæ¸¸ä»£ç å·²å…‹éš†"

      - name: åº”ç”¨æ±‰åŒ–è¡¥ä¸
        id: apply
        run: |
          # è¿è¡Œæ±‰åŒ–å¹¶æ•èŽ·è¾“å‡º
          OUTPUT=$(node cli/index.mjs apply --verbose 2>&1) || true
          echo "$OUTPUT"
          
          # æå–ç»Ÿè®¡ä¿¡æ¯
          APPLIED=$(echo "$OUTPUT" | grep "æ€»è®¡:" | sed 's/.*åº”ç”¨ \([0-9]*\).*/\1/' || echo "0")
          EXISTED=$(echo "$OUTPUT" | grep "æ€»è®¡:" | sed 's/.*å·²å­˜åœ¨ \([0-9]*\).*/\1/' || echo "0")
          FAILED=$(echo "$OUTPUT" | grep "æ€»è®¡:" | sed 's/.*æœªæ‰¾åˆ° \([0-9]*\).*/\1/' || echo "0")
          FILES_COUNT=$(echo "$OUTPUT" | grep -c "æ›¿æ¢:" || echo "0")
          
          # å¦‚æžœæå–å¤±è´¥ï¼Œè®¾ç½®é»˜è®¤å€¼
          [ -z "$APPLIED" ] && APPLIED="0"
          [ -z "$EXISTED" ] && EXISTED="0"
          [ -z "$FAILED" ] && FAILED="0"
          
          echo "applied=$APPLIED" >> $GITHUB_OUTPUT
          echo "existed=$EXISTED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "files=$FILES_COUNT" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ðŸ“Š æ±‰åŒ–ç»Ÿè®¡ï¼š"
          echo "   âœ… åº”ç”¨è§„åˆ™: $APPLIED æ¡"
          echo "   â­ï¸ å·²å­˜åœ¨: $EXISTED æ¡"
          echo "   âš ï¸ æœªåŒ¹é…: $FAILED æ¡"
          echo "   ðŸ“ æ›¿æ¢æ“ä½œ: $FILES_COUNT æ¬¡"
          echo ""
          echo "âœ… æ±‰åŒ–è¡¥ä¸å·²åº”ç”¨"

      - name: éªŒè¯æ±‰åŒ–ç»“æžœ
        run: |
          node cli/index.mjs verify
          echo "âœ… æ±‰åŒ–éªŒè¯é€šè¿‡"

      - name: æž„å»º OpenClaw
        working-directory: openclaw
        run: |
          pnpm install
          pnpm run build
          echo "âœ… æž„å»ºå®Œæˆ"

      - name: å‡†å¤‡å‘å¸ƒ
        run: |
          RELEASE_VERSION="${{ steps.version.outputs.release_version }}"
          
          cd openclaw
          npm version $RELEASE_VERSION --no-git-tag-version --allow-same-version || true
          
          # ä¿®æ”¹åŒ…ä¿¡æ¯
          jq '.name = "@qingchencloud/openclaw-zh"' package.json > tmp.json && mv tmp.json package.json
          jq '.description = "OpenClaw æ±‰åŒ–å‘è¡Œç‰ˆï¼ˆç¨³å®šç‰ˆï¼‰- æ­¦æ±‰æ™´è¾°å¤©ä¸‹ç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸"' package.json > tmp.json && mv tmp.json package.json
          
          # ä½¿ç”¨ä¸­æ–‡ README
          cp ../README.md ./README.md
          echo "âœ… å‘å¸ƒå‡†å¤‡å®Œæˆ"

      - name: å‘å¸ƒåˆ° npm (@latest)
        working-directory: openclaw
        run: npm publish --access public --tag latest
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.release_version }}
          name: "ðŸ¦ž OpenClaw æ±‰åŒ–ç‰ˆ v${{ steps.version.outputs.release_version }}"
          body: |
            ## ðŸ¦ž OpenClaw æ±‰åŒ–å‘è¡Œç‰ˆ - ç¨³å®šç‰ˆ
            
            **ç‰ˆæœ¬**: v${{ steps.version.outputs.release_version }}
            **ä¸Šæ¸¸ç‰ˆæœ¬**: ${{ steps.upstream.outputs.version }}
            **å‘å¸ƒç±»åž‹**: ç¨³å®šç‰ˆ (Stable)
            
            ---
            
            ### ðŸ“Š æ±‰åŒ–ç»Ÿè®¡
            
            | æŒ‡æ ‡ | æ•°é‡ | è¯´æ˜Ž |
            |------|------|------|
            | âœ… åº”ç”¨è§„åˆ™ | **${{ steps.apply.outputs.applied }}** æ¡ | æˆåŠŸåº”ç”¨çš„ç¿»è¯‘è§„åˆ™ |
            | â­ï¸ å·²å­˜åœ¨ | ${{ steps.apply.outputs.existed }} æ¡ | ç¿»è¯‘å·²å­˜åœ¨ï¼Œè·³è¿‡ |
            | âš ï¸ æœªåŒ¹é… | ${{ steps.apply.outputs.failed }} æ¡ | æºç å˜æ›´å¯¼è‡´æœªåŒ¹é… |
            | ðŸ“ æ›¿æ¢æ“ä½œ | ${{ steps.apply.outputs.files }} æ¬¡ | å®žé™…æ‰§è¡Œçš„æ›¿æ¢æ¬¡æ•° |
            
            ---
            
            ### ðŸ“¦ å®‰è£…æ–¹å¼
            
            **ç¨³å®šç‰ˆï¼ˆæŽ¨èï¼‰ï¼š**
            ```bash
            npm install -g @qingchencloud/openclaw-zh@latest
            ```
            
            **æœ€æ–°ç‰ˆï¼ˆæ¯å°æ—¶æ›´æ–°ï¼‰ï¼š**
            ```bash
            npm install -g @qingchencloud/openclaw-zh@nightly
            ```
            
            **ä¸€é”®å®‰è£…è„šæœ¬ï¼š**
            ```bash
            # Linux/macOS
            curl -fsSL https://cdn.jsdelivr.net/gh/1186258278/OpenClawChineseTranslation@main/install.sh | bash
            
            # Windows PowerShell
            powershell -c "irm https://cdn.jsdelivr.net/gh/1186258278/OpenClawChineseTranslation@main/install.ps1 | iex"
            ```
            
            ---
            
            ### ðŸ”— ç›¸å…³é“¾æŽ¥
            
            - ðŸ”¥ å®˜ç½‘: https://openclaw.qt.cool/
            - ðŸ“– æ–‡æ¡£: https://github.com/1186258278/OpenClawChineseTranslation
            - ðŸ“¦ npm: https://www.npmjs.com/package/@qingchencloud/openclaw-zh
            - ðŸŒ™ æœ€æ–°ç‰ˆ: https://github.com/1186258278/OpenClawChineseTranslation/releases/tag/nightly
            
            ---
            
            **æ­¦æ±‰æ™´è¾°å¤©ä¸‹ç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸** | https://qingchencloud.com/
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==================== Docker é•œåƒæž„å»ºä¸ŽæŽ¨é€ ====================
      - name: å‡†å¤‡ Docker æž„å»º
        run: |
          # å¤åˆ¶ Dockerfile å’Œ .dockerignore åˆ°æž„å»ºç›®å½•
          cp Dockerfile openclaw/Dockerfile
          cp .dockerignore openclaw/.dockerignore 2>/dev/null || true
          
          # éªŒè¯æž„å»ºäº§ç‰©å­˜åœ¨
          echo "ðŸ“¦ æ£€æŸ¥æž„å»ºäº§ç‰©..."
          ls -la openclaw/
          ls -la openclaw/dist/ || echo "âš ï¸ dist/ ç›®å½•ä¸å­˜åœ¨"
          
          # ç¡®ä¿ dist ç›®å½•å­˜åœ¨
          if [ ! -d "openclaw/dist" ]; then
            echo "âŒ é”™è¯¯ï¼šdist/ ç›®å½•ä¸å­˜åœ¨ï¼ŒDocker æž„å»ºå°†å¤±è´¥"
            exit 1
          fi

          # -----------------------------------------------------------
          # å…³é”®ä¿®æ”¹ï¼šåˆ é™¤å®¿ä¸»æœºç”Ÿæˆçš„ node_modules
          # -----------------------------------------------------------
          # å¿…é¡»åˆ é™¤ï¼Œé˜²æ­¢å°† x86_64 çš„åŽŸç”Ÿä¾èµ–æ‹·è´åˆ° arm64 é•œåƒä¸­
          echo "ðŸ§¹ æ¸…ç†å®¿ä¸»æœº x86_64 ä¾èµ– (node_modules)..."
          rm -rf openclaw/node_modules
          
          echo "âœ… Docker æž„å»ºå‡†å¤‡å®Œæˆ"

      # -----------------------------------------------------------
      # å…³é”®ä¿®æ”¹ï¼šæ·»åŠ  QEMU æ”¯æŒ (ç”¨äºŽæ¨¡æ‹Ÿ ARM64 æž„å»ºçŽ¯å¢ƒ)
      # -----------------------------------------------------------
      - name: è®¾ç½® QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: å‡†å¤‡ Docker å…ƒæ•°æ®
        id: docker_meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/openclaw-zh
          tags: |
            type=raw,value=latest
            type=raw,value=${{ steps.version.outputs.release_version }}

      - name: æž„å»ºå¹¶æŽ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./openclaw
          push: true
          tags: ${{ steps.docker_meta.outputs.tags }}
          labels: ${{ steps.docker_meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: è®¾ç½®é•œåƒä¸ºå…¬å¼€
        run: |
          # ä½¿ç”¨ GitHub API å°†åŒ…è®¾ç½®ä¸ºå…¬å¼€
          curl -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/user/packages/container/openclaw-zh/versions \
            -d '{"visibility":"public"}' || true
          echo "âœ… Docker é•œåƒå·²æŽ¨é€åˆ° ghcr.io"

      - name: æž„å»ºæ‘˜è¦
        run: |
          echo "## ðŸ¦ž ç¨³å®šç‰ˆå‘å¸ƒå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬å· | v${{ steps.version.outputs.release_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ä¸Šæ¸¸ç‰ˆæœ¬ | ${{ steps.upstream.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| åº”ç”¨è§„åˆ™ | ${{ steps.apply.outputs.applied }} æ¡ |" >> $GITHUB_STEP_SUMMARY
          echo "| æœªåŒ¹é…è§„åˆ™ | ${{ steps.apply.outputs.failed }} æ¡ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ å®‰è£…æ–¹å¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**npm**: \`npm install -g @qingchencloud/openclaw-zh@latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Docker**: \`docker pull ghcr.io/${{ github.repository_owner }}/openclaw-zh:latest\`" >> $GITHUB_STEP_SUMMARY
